ç­–ç•¥æ³¨å†Œä¸æŒä¹…åŒ– - ç”¨æˆ·å¿«é€Ÿå‚è€ƒ
==================================

## å¿«é€Ÿå¼€å§‹

### 1. åˆ›å»ºæ–°ç­–ç•¥

#### æ­¥éª¤ 1ï¼šå¤åˆ¶æ¨¡æ¿
```bash
cp -r strategies/strategy_template strategies/my_rsi_strategy
```

#### æ­¥éª¤ 2ï¼šç¼–è¾‘ manifest.json
```json
{
  "strategy_id": "my_rsi_strategy",        // å”¯ä¸€ IDï¼ˆå¿…å¡«ï¼‰
  "display_name": "RSI è¶…ä¹°è¶…å– ğŸ“Š",        // UI æ˜¾ç¤ºåç§°ï¼ˆå¿…å¡«ï¼‰
  "version": "1.0.0",                      // ç‰ˆæœ¬å·
  "description": "åŸºäº RSI æŒ‡æ ‡çš„ç­–ç•¥",    // æè¿°
  "class_name": "RSIStrategy",             // Python ç±»åï¼ˆå¿…å¡«ï¼‰
  "order": 50                              // æ’åºï¼ˆå¯é€‰ï¼‰
}
```

#### æ­¥éª¤ 3ï¼šç¼–è¾‘ __init__.py
```python
class RSIStrategy:
    def __init__(self):
        self.rsi_period = 14
        self.overbought = 70
        self.oversold = 30
    
    def analyze(self, df):
        # è®¡ç®— RSI...
        return {
            'signal': 'BUY' / 'SELL' / 'HOLD',
            'confidence': 0.0-1.0,
            'entry_price': 100.0,
            'stop_loss': 95.0,
            'take_profit': 110.0,
            'reason': 'åŸå› è¯´æ˜'
        }
    
    def get_position_size(self, symbol, balance, leverage=1.0):
        return balance * 0.05  # 5% ä»“ä½
```

#### æ­¥éª¤ 4ï¼šé‡å¯åº”ç”¨
```bash
# æ–°ç­–ç•¥è‡ªåŠ¨å‡ºç°åœ¨ UI ä¸‹æ‹‰èœå•ä¸­
```

---

## UI ä½¿ç”¨æŒ‡å—

### ç­–ç•¥é€‰æ‹©
1. **ä¾§è¾¹æ ** â†’ **ğŸ“ ç­–ç•¥åˆ‡æ¢** ä¸‹æ‹‰æ¡†
2. é€‰æ‹©ç­–ç•¥ â†’ è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“
3. **åˆ·æ–°é¡µé¢** â†’ ä»é€‰ä¸­ä¸Šæ¬¡çš„ç­–ç•¥

### ç­–ç•¥æ˜¾ç¤ºåç§°
- UI ä¸‹æ‹‰æ¡†æ˜¾ç¤º `display_name`ï¼ˆå¦‚ "è¶‹åŠ¿ç­–ç•¥ v2" è€Œé "strategy_v2"ï¼‰
- åç«¯ä½¿ç”¨ `strategy_id` ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼ˆå¦‚ "strategy_v2"ï¼‰

### ç­–ç•¥éªŒè¯ä¸å›é€€
- è‹¥æ•°æ®åº“ä¸­çš„ `strategy_id` æ— æ•ˆï¼ˆç­–ç•¥å·²åˆ é™¤ï¼‰
- UI è‡ªåŠ¨å›é€€åˆ°é»˜è®¤ç­–ç•¥å¹¶ä¿å­˜
- ä¸ä¼šå¯¼è‡´åº”ç”¨å´©æºƒ

---

## åç«¯ API

### ç­–ç•¥æ³¨å†Œè¡¨
```python
from strategy_registry import get_strategy_registry

registry = get_strategy_registry()

# åˆ—å‡ºæ‰€æœ‰ç­–ç•¥
strategies = registry.list_strategies()
# è¿”å›ï¼š[
#   {'strategy_id': 'strategy_v1', 'display_name': 'è¶‹åŠ¿ç­–ç•¥ v1', ...},
#   ...
# ]

# è·å–ç­–ç•¥å…ƒæ•°æ®
meta = registry.get_strategy_meta('strategy_v1')

# å®ä¾‹åŒ–ç­–ç•¥
strategy = registry.instantiate_strategy('strategy_v1')
signal = strategy.analyze(df)
```

### æŸ¥è¯¢ä¸æŒä¹…åŒ–
```python
from db_bridge import get_bootstrap_state, update_bot_config

# è¯»å–å½“å‰é…ç½®ï¼ˆåŒ…æ‹¬ selected_strategy_idï¼‰
boot = get_bootstrap_state()
current_strategy = boot['selected_strategy_id']

# æ›´æ–°ç­–ç•¥é€‰æ‹©
update_bot_config(selected_strategy_id='strategy_v2')
```

### éªŒè¯ä¸å›é€€
```python
from strategy_registry import validate_and_fallback_strategy

# éªŒè¯ strategy_idï¼Œæ— æ•ˆåˆ™å›é€€åˆ°é»˜è®¤
valid_id = validate_and_fallback_strategy('potentially_invalid_id')
```

---

## å¸¸è§é—®é¢˜

### Q: æ–°ç­–ç•¥åˆ›å»ºåä¸æ˜¾ç¤ºåœ¨ä¸‹æ‹‰èœå•ä¸­
**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. ç›®å½•æ˜¯å¦åœ¨ `strategies/` ä¸‹
2. æ˜¯å¦æœ‰ `manifest.json` æ–‡ä»¶
3. JSON æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆæ— è¯­æ³•é”™è¯¯ï¼‰
4. æ˜¯å¦æœ‰ `__init__.py` æ–‡ä»¶
5. `class_name` æ˜¯å¦ä¸ Python ç±»ååŒ¹é…
6. é‡å¯åº”ç”¨ï¼ˆUI åŠ è½½æ—¶æ‰«æç­–ç•¥ï¼‰

### Q: é€‰æ‹©ç­–ç•¥åé¡µé¢åˆ·æ–°å°±æ¢å¤ä¸ºä¸Šä¸€ä¸ªç­–ç•¥
**A**: è¿™æ˜¯é¢„æœŸè¡Œä¸ºï¼Œè¯´æ˜ `on_change` å›è°ƒæˆåŠŸäº†ï¼š
1. ç”¨æˆ·é€‰æ‹©æ–°ç­–ç•¥
2. `on_change` å°†æ–° ID å†™å…¥ DB
3. `st.rerun()` é‡æ–°æ¸²æŸ“
4. ä» DB è¯»å–å·²ä¿å­˜çš„æ–° ID
5. æ˜¾ç¤ºæ–°ç­–ç•¥ï¼ˆéªŒè¯æˆåŠŸï¼‰

### Q: ç­–ç•¥ä»£ç ä¸­æœ‰ bugï¼Œæ”¹å®Œåå¦‚ä½•ç«‹å³ç”Ÿæ•ˆ
**A**:
1. ä¿®æ”¹ `strategies/xxx/__init__.py`
2. **é‡å¯åº”ç”¨**ï¼ˆPython æ¨¡å—éœ€è¦é‡æ–°åŠ è½½ï¼‰
3. é€‰æ‹©è¯¥ç­–ç•¥é‡æ–°è¿è¡Œ

### Q: å¦‚ä½•åœ¨å¤šä¸ªç­–ç•¥é—´å¿«é€Ÿå¯¹æ¯”
**A**:
1. åœ¨ UI ä¸‹æ‹‰æ¡†å¿«é€Ÿåˆ‡æ¢
2. æ¯æ¬¡åˆ‡æ¢è‡ªåŠ¨ä¿å­˜å’Œé‡å¯äº¤æ˜“å¼•æ“
3. æŸ¥çœ‹æ—¥å¿—å¯¹æ¯”æ€§èƒ½æŒ‡æ ‡

### Q: èƒ½å¦ä¸ºåŒä¸€ç­–ç•¥åˆ›å»ºå¤šä¸ªç‰ˆæœ¬
**A**: å¯ä»¥ï¼Œå°†å…¶ä½œä¸ºä¸åŒçš„ `strategy_id`ï¼š
```
strategies/
â”œâ”€â”€ my_rsi_v1/
â”‚   â””â”€â”€ manifest.json (strategy_id: "my_rsi_v1")
â””â”€â”€ my_rsi_v2/
    â””â”€â”€ manifest.json (strategy_id: "my_rsi_v2")
```
ä¸¤ä¸ªç‰ˆæœ¬éƒ½ä¼šå‡ºç°åœ¨ä¸‹æ‹‰èœå•ä¸­ã€‚

---

## æŠ€æœ¯ç»†èŠ‚

### æ•°æ®æµï¼ˆç”¨æˆ·è§†è§’ï¼‰
```
ç”¨æˆ·æ‰“å¼€åº”ç”¨
  â†“ bootstrap ä» DB è¯»å– selected_strategy_id
  â†“ UI åˆå§‹åŒ–æ—¶è®¾ç½® st.session_state.selected_strategy_id
  â†“ selectbox æ˜¾ç¤ºå½“å‰ç­–ç•¥
  â†“
ç”¨æˆ·é€‰æ‹©æ–°ç­–ç•¥ï¼ˆè§¦å‘ selectbox çš„ on_changeï¼‰
  â†“ _on_strategy_change() å›è°ƒæ‰§è¡Œ
  â†“ update_bot_config(selected_strategy_id=new_id) å†™ DB
  â†“ st.rerun() é¡µé¢é‡æ–°æ¸²æŸ“
  â†“
ç”¨æˆ·åˆ·æ–°é¡µé¢ï¼ˆF5ï¼‰
  â†“ bootstrap é‡æ–°ä» DB è¯»å–å·²ä¿å­˜çš„ selected_strategy_id
  â†“ UI æ¢å¤ä¸Šæ¬¡é€‰æ‹©çš„ç­–ç•¥ âœ“
```

### ç¨³å®š ID åŸç†
- **æ—§æ–¹æ³•**ï¼šä½¿ç”¨ä¸‹æ‹‰èœå•çš„ index ç»‘å®šç­–ç•¥
  - é—®é¢˜ï¼šæ’åºæ”¹å˜ â†’ index ä¸åŒ â†’ ç­–ç•¥é”™ä½
- **æ–°æ–¹æ³•**ï¼šä½¿ç”¨ strategy_id å­—ç¬¦ä¸²ç»‘å®šç­–ç•¥
  - æ–¹æ¡ˆï¼šæ— è®ºä¸‹æ‹‰é¡ºåºå¦‚ä½•ï¼Œstrategy_id å§‹ç»ˆå¯¹åº”åŒä¸€ç­–ç•¥
  - è‡ªåŠ¨æ’åºï¼šæŒ‰ manifest.json çš„ `order` å­—æ®µç¨³å®šæ’åº

### æ— æ•ˆå›é€€æœºåˆ¶
```python
def validate_and_fallback_strategy(strategy_id):
    registry = get_strategy_registry()
    if strategy_id and registry.validate_strategy_id(strategy_id):
        return strategy_id  # æœ‰æ•ˆï¼Œç›´æ¥è¿”å›
    return registry.get_default_strategy_id()  # æ— æ•ˆï¼Œå›é€€åˆ°é»˜è®¤
```

---

## æœ€ä½³å®è·µ

### å‘½åçº¦å®š
- `strategy_id`: è‹±æ–‡ + ä¸‹åˆ’çº¿ï¼Œå¦‚ `my_rsi_strategy`ã€`trend_follow_v2`
- `display_name`: å¯ç”¨ä¸­æ–‡ + emojiï¼Œå¦‚ "RSI è¶…ä¹°è¶…å– ğŸ“Š"ã€"è¶‹åŠ¿è¿½è¸ª v2"
- Python ç±»åï¼šPascalCaseï¼Œå¦‚ `RSIStrategy`ã€`TrendFollowStrategy`

### å‚æ•°ç®¡ç†
- åœ¨ `__init__()` ä¸­å®šä¹‰å‚æ•°ï¼Œä¾¿äºè°ƒæ•´
- æä¾› `set_parameters(**kwargs)` æ–¹æ³•ç”¨äºåŠ¨æ€é…ç½®
- åœ¨æ¨¡æ¿ä¸­å®šä¹‰ `STRATEGY_PARAMS` ç”¨äº UI å±•ç¤ºå‚æ•°é¢æ¿

### é”™è¯¯å¤„ç†
- `analyze()` è¿”å›çš„ dict å¿…é¡»åŒ…å« `signal` å’Œ `confidence`
- å…¶ä»–å­—æ®µï¼ˆentry_priceã€stop_loss ç­‰ï¼‰å¯é€‰
- è‹¥æ•°æ®ä¸è¶³ï¼Œè¿”å› `{'signal': 'HOLD', 'confidence': 0, ...}`

### æ€§èƒ½ä¼˜åŒ–
- é¿å…åœ¨ `analyze()` ä¸­è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®
- é‡å¤è®¡ç®—çš„æŒ‡æ ‡åœ¨ `__init__()` åè®¡ç®—ï¼Œé¿å…é€æ¬¡è®¡ç®—
- å¯¹å¤§æ•°æ®é›†ï¼ˆ>1000 è¡Œï¼‰ä½¿ç”¨å‘é‡åŒ–æ“ä½œï¼ˆnumpy/pandasï¼‰

---

## æ›´æ–°æ—¥å¿—

### v1.0 (2025-12-15)
- âœ“ å®ç°ç­–ç•¥æ³¨å†Œè¡¨ï¼ˆstrategy_registry.pyï¼‰
- âœ“ ä¿®æ”¹ UI selectbox ä½¿ç”¨ç¨³å®š strategy_id
- âœ“ æ·»åŠ  DB åˆ—è¿ç§»ï¼Œæ”¯æŒè·¨åˆ·æ–°æŒä¹…åŒ–
- âœ“ åˆ›å»ºç­–ç•¥æ¨¡æ¿ä¸åˆ›å»ºæŒ‡å—
- âœ“ é€šè¿‡å…¨éƒ¨éªŒæ”¶æµ‹è¯•ï¼ˆ5 é¡¹ï¼‰
- âœ“ æ–‡æ¡£ä¸å¿«é€Ÿå‚è€ƒå®Œæˆ

---

## è·å–å¸®åŠ©

### è¿è¡Œæµ‹è¯•
```bash
python test_strategy_persistence.py
```

### æŸ¥çœ‹ç­–ç•¥åˆ—è¡¨
```python
from strategy_registry import list_all_strategies
for display_name, strategy_id in list_all_strategies():
    print(f"{display_name} ({strategy_id})")
```

### è°ƒè¯•ç­–ç•¥
```python
from strategy_registry import get_strategy_registry
import pandas as pd

registry = get_strategy_registry()
strategy = registry.instantiate_strategy('my_rsi_strategy')

# è¯»å–æ•°æ®
df = pd.read_csv('test_data.csv')  # OHLCV æ ¼å¼

# æµ‹è¯•ä¿¡å·
signal = strategy.analyze(df)
print(signal)
```
