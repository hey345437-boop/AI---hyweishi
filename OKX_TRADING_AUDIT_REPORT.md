# OKX äº¤æ˜“ä¸ä»“ä½å®¡è®¡æŠ¥å‘Š

**å®¡è®¡æ—¥æœŸ**: 2024-12-16  
**é¡¹ç›®**: Python é‡åŒ–äº¤æ˜“ç³»ç»Ÿ (Streamlit + ccxt/OKX)  
**å®¡è®¡èŒƒå›´**: ä»“ä½ä½“ç³»ã€ä¸‹å•æ–¹å¼ã€äº¤æ˜“é€»è¾‘ã€é£é™©ç‚¹

---

## ä¸€ã€ç»“è®ºæ€»è§ˆ

| å®¡è®¡é¡¹ | ç»“è®º | é£é™©ç­‰çº§ | çŠ¶æ€ |
|--------|------|----------|------|
| ä»“ä½æ¨¡å¼ | **åŒå‘æŒä»“æ¨¡å¼ (long/short)** | âš ï¸ ä¸­ | âœ… å·²ä¿®å¤ |
| åŒå¸å¯¹å¤šç©ºåŒæŒ | **æ”¯æŒ** (é€šè¿‡ posSide åŒºåˆ†) | âœ… ä½ | âœ… æ­£å¸¸ |
| äº¤æ˜“å“ç§ | **æ°¸ç»­åˆçº¦ (swap)** | âœ… ä½ | âœ… æ­£å¸¸ |
| ä¿è¯é‡‘æ¨¡å¼ | **å…¨ä»“ (cross)** - é»˜è®¤é…ç½® | âœ… ä½ | âœ… æ­£å¸¸ |
| ä¸‹å•æ–¹å¼ | ccxt.create_order (REST) | âœ… ä½ | âœ… æ­£å¸¸ |
| è®¢å•ç±»å‹ | ä»… market å¸‚ä»·å• | âš ï¸ ä¸­ | â³ å¾…æ‰©å±• |
| å¹‚ç­‰æ€§ä¿æŠ¤ | **å·²æ·»åŠ  clOrdId** | âœ… ä½ | âœ… å·²ä¿®å¤ |
| ä¿¡å·å»é‡ | **å®ç›˜å·²æ·»åŠ å»é‡** | âœ… ä½ | âœ… å·²ä¿®å¤ |
| ç¯å¢ƒåˆ‡æ¢ | sandbox/live é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶ | âœ… ä½ | âœ… å·²ä¿®å¤ |


---

## äºŒã€è¯æ®æ¸…å•

### 2.1 ä»“ä½è¯»å–æ–¹å¼

**ç»“è®º**: ä½¿ç”¨ `ccxt.fetch_positions()` REST API è·å–ä»“ä½

**æ–‡ä»¶**: `exchange_adapters/okx_adapter.py`  
**å‡½æ•°**: `fetch_positions()`

```python
def fetch_positions(self, symbols: Optional[list] = None) -> Any:
    # è§„èŒƒåŒ– symbols
    normalized_symbols = None
    if symbols:
        normalized_symbols = [self.normalize_symbol(symbol) for symbol in symbols]
        logger.info(f"Fetching positions for {normalized_symbols}")
    else:
        logger.info("Fetching all positions")
    
    return self.exchange.fetch_positions(normalized_symbols)
```

**è¯æ˜**: ç›´æ¥è°ƒç”¨ ccxt çš„ `fetch_positions` æ–¹æ³•ï¼Œé€šè¿‡ REST API è·å–æŒä»“æ•°æ®ã€‚

---

### 2.2 ä»“ä½æ¨¡å¼åˆ¤æ–­ - åŒå‘æŒä»“ (long/short)

**ç»“è®º**: é¡¹ç›®ä½¿ç”¨ **åŒå‘æŒä»“æ¨¡å¼**ï¼Œé€šè¿‡ `posSide` å‚æ•°åŒºåˆ†å¤šç©º

**æ–‡ä»¶**: `separated_system/trade_engine.py`  
**è¡Œå·**: 888-890

```python
plan_order = {
    "symbol": symbol,
    "side": "buy",
    "amount": base_position_size,
    "order_type": "market",
    "posSide": "long",  # å¤šç©ºæ–¹å‘
    "tdMode": OKX_TD_MODE  # æŒä»“æ¨¡å¼
}
```

**ç´§æ€¥å¹³ä»“é€»è¾‘** (è¡Œ 467-479):
```python
posSide = "long" if position.get("positionAmt") > 0 else "short"
# ...
params={
    "posSide": posSide,
    "tdMode": OKX_TD_MODE
}
```

**è¯æ˜**: 
1. ä¸‹å•æ—¶æ˜¾å¼ä¼ é€’ `posSide: "long"` æˆ– `"short"`
2. ç´§æ€¥å¹³ä»“æ—¶æ ¹æ®æŒä»“æ–¹å‘åŠ¨æ€è®¾ç½® `posSide`
3. ç¬¦åˆ OKX åŒå‘æŒä»“æ¨¡å¼è¦æ±‚

---

### 2.3 äº¤æ˜“å“ç§ - æ°¸ç»­åˆçº¦ (swap)

**ç»“è®º**: é»˜è®¤ä½¿ç”¨ **USDT æ°¸ç»­åˆçº¦**

**æ–‡ä»¶**: `config.py`  
**è¡Œå·**: 31

```python
OKX_MARKET_TYPE = os.getenv("OKX_MARKET_TYPE", "swap")
```

**æ–‡ä»¶**: `exchange_adapters/okx_adapter.py`  
**è¡Œå·**: 88-89

```python
if 'defaultType' not in self.options:
    self.options['defaultType'] = 'swap'
```

**Symbol è§„èŒƒåŒ–** (è¡Œ 119-123):
```python
def normalize_symbol(self, symbol: str) -> str:
    # å¤„ç†åˆçº¦æ ¼å¼
    base, quote = symbol.split('/')
    # OKX æ°¸ç»­åˆçº¦æ ¼å¼ä¸º BASE/QUOTE:QUOTE
    return f"{base}/{quote}:{quote}"
```

**è¯æ˜**: 
1. ç¯å¢ƒå˜é‡é»˜è®¤ `OKX_MARKET_TYPE=swap`
2. ccxt options è®¾ç½® `defaultType: 'swap'`
3. Symbol è‡ªåŠ¨è½¬æ¢ä¸ºæ°¸ç»­åˆçº¦æ ¼å¼ `BTC/USDT:USDT`

---

### 2.4 ä¿è¯é‡‘æ¨¡å¼ - å…¨ä»“ (cross)

**ç»“è®º**: é»˜è®¤ä½¿ç”¨ **å…¨ä»“æ¨¡å¼ (cross)**

**æ–‡ä»¶**: `config.py`  
**è¡Œå·**: 32

```python
OKX_TD_MODE = os.getenv("OKX_TD_MODE", "cross")
```

**ä¸‹å•æ—¶ä¼ é€’** (`separated_system/trade_engine.py` è¡Œ 946):
```python
params={
    "posSide": plan_order["posSide"],
    "tdMode": plan_order["tdMode"]  # æ¥è‡ª OKX_TD_MODE
}
```

**è¯æ˜**: ç¯å¢ƒå˜é‡ `OKX_TD_MODE` é»˜è®¤ä¸º `cross`ï¼Œä¸‹å•æ—¶é€šè¿‡ params ä¼ é€’ç»™ OKX APIã€‚


---

### 2.5 ä¸‹å•æ–¹å¼ä¸å‚æ•°

**ç»“è®º**: ä½¿ç”¨ `ccxt.create_order()` REST APIï¼Œä»…æ”¯æŒå¸‚ä»·å•

**æ–‡ä»¶**: `exchange_adapters/okx_adapter.py`  
**å‡½æ•°**: `create_order()`

```python
def create_order(self, symbol: str, side: str, amount: float, 
                 order_type: str = 'market', params: Optional[Dict] = None) -> Any:
    # é£æ§æ£€æŸ¥
    validation_result = self.risk_control.validate_order(amount, symbol)
    if not validation_result.is_valid:
        raise ValueError(f"é£æ§æ‹’ç»è®¢å•: {validation_result.error_message}")
    
    # è§„èŒƒåŒ– symbol
    normalized_symbol = self.normalize_symbol(symbol)
    logger.info(f"Creating order: {side} {amount} {normalized_symbol} ({order_type})")
    
    return self.exchange.create_order(normalized_symbol, order_type, side, amount, 
                                       price=None, params=params)
```

**å…³é”®å‚æ•°å®¡è®¡**:
| å‚æ•° | æ˜¯å¦ä¼ é€’ | å€¼ |
|------|----------|-----|
| symbol | âœ… | è§„èŒƒåŒ–åçš„åˆçº¦æ ¼å¼ |
| side | âœ… | buy/sell |
| amount | âœ… | æ•°é‡ |
| order_type | âœ… | å›ºå®š "market" |
| price | âŒ | None (å¸‚ä»·å•ä¸éœ€è¦) |
| posSide | âœ… | long/short |
| tdMode | âœ… | cross (é»˜è®¤) |
| reduceOnly | âŒ | **æœªä¼ é€’** |
| clOrdId | âŒ | **æœªä¼ é€’** |

---

### 2.6 ç¯å¢ƒåˆ‡æ¢é€»è¾‘

**ç»“è®º**: é€šè¿‡ `OKX_SANDBOX` ç¯å¢ƒå˜é‡æ§åˆ¶ demo/live æ¨¡å¼

**æ–‡ä»¶**: `exchange_adapters/okx_adapter.py`  
**è¡Œå·**: 259-265

```python
# æ ¹æ®ç¯å¢ƒè®¾ç½®æ²™ç›’æ¨¡å¼
if self.env == 'demo':
    self.exchange.set_sandbox_mode(True)
    logger.info("OKX sandbox mode enabled")
else:
    self.exchange.set_sandbox_mode(False)
    logger.info("OKX production mode enabled")
```

**æ–‡ä»¶**: `okx_client.py`  
**è¡Œå·**: 235 (Demo æ¨¡å¼å¤´éƒ¨æ³¨å…¥)

```python
# Demo æ¨¡å¼ï¼šä¸ºç§æœ‰æ¥å£æ·»åŠ  x-simulated-trading å¤´
if config.mode == Mode.DEMO and for_private:
    result['headers']['x-simulated-trading'] = '1'
```

**è¯æ˜**: 
1. `OKX_SANDBOX=true` æ—¶å¯ç”¨æ²™ç›’æ¨¡å¼
2. Demo æ¨¡å¼è‡ªåŠ¨æ·»åŠ  `x-simulated-trading: '1'` å¤´
3. å½“å‰ `.env` é…ç½® `OKX_SANDBOX=false` è¡¨ç¤ºä½¿ç”¨å®ç›˜ API

---

### 2.7 ç­–ç•¥ä¿¡å·æ¥æº

**ç»“è®º**: åŸºäº K çº¿æŠ€æœ¯æŒ‡æ ‡ç”Ÿæˆä¿¡å·

**æ–‡ä»¶**: `strategy_v2.py`  
**ç±»**: `TradingStrategy`

**ä¿¡å·ç±»å‹**:
- `MAIN_TREND`: è¶‹åŠ¿ä¸»ä¿¡å· (EMA + RSI + MACD)
- `SUB_BOTTOM`: æŠ„åº•ä¿¡å· (Stochastic + OBV)
- `SUB_TOP`: é€ƒé¡¶ä¿¡å·
- `SUB_ORDER_BLOCK`: SMC è®¢å•å—ä¿¡å·
- `TP_*`: æ­¢ç›ˆä¿¡å· (ä»…å¹³ä»“)

**ä¿¡å·ç”Ÿæˆ** (è¡Œ 608-620):
```python
if trend_buy:
    return {
        "action": "BUY",
        "type": "MAIN_TREND",
        "position_pct": self.main_signal_pct,
        "leverage": 50,
        "reason": f"[{timeframe}]è¶‹åŠ¿2.3ä¸»åšå¤šä¿¡å· | EMA12={curr['ema12']:.2f}"
    }
```

**é£æ§å‚æ•°** (è¡Œ 27-30):
```python
self.max_leverage = 50
self.max_total_position_pct = 0.10
self.main_signal_pct = 0.03
self.sub_signal_pct = 0.01
```


---

## ä¸‰ã€é£é™©æ¸…å•ä¸ä¿®å¤å»ºè®®

### ğŸ”´ P0 - ä¸¥é‡é£é™© (å¿…é¡»ç«‹å³ä¿®å¤)

#### é£é™© 1: æ— è®¢å•å¹‚ç­‰æ€§ä¿æŠ¤ (clOrdId æœªä½¿ç”¨)

**é—®é¢˜**: ä¸‹å•æ—¶æœªä¼ é€’ `clOrdId` (å®¢æˆ·ç«¯è®¢å•ID)ï¼Œç½‘ç»œé‡è¯•æˆ–å¼‚å¸¸æ¢å¤å¯èƒ½å¯¼è‡´é‡å¤ä¸‹å•ã€‚

**è¯æ®**: å…¨å±€æœç´¢ `clOrdId|client_order_id|clientOrderId` æ— åŒ¹é…ç»“æœã€‚

**å½±å“**: 
- ç½‘ç»œè¶…æ—¶åé‡è¯•å¯èƒ½å¯¼è‡´åŒä¸€ä¿¡å·ä¸‹ä¸¤æ¬¡å•
- æ— æ³•å®ç°è®¢å•å¹‚ç­‰æ€§æ ¡éªŒ
- æ— æ³•è¿½è¸ªè®¢å•æ¥æº

**ä¿®å¤å»ºè®®**:
```python
import uuid

def create_order(self, symbol, side, amount, order_type='market', params=None):
    if params is None:
        params = {}
    
    # ç”Ÿæˆå”¯ä¸€è®¢å•ID (æ ¼å¼: signal_timestamp_uuid)
    if 'clOrdId' not in params:
        params['clOrdId'] = f"sig_{int(time.time()*1000)}_{uuid.uuid4().hex[:8]}"
    
    return self.exchange.create_order(...)
```

---

#### é£é™© 2: å®ç›˜æ— ä¿¡å·å»é‡æœºåˆ¶

**é—®é¢˜**: å›æµ‹ä»£ç æœ‰ `last_signal_candle` å»é‡ï¼Œä½†å®ç›˜ `trade_engine.py` æ— æ­¤æœºåˆ¶ã€‚

**è¯æ®** (`simulation.py` è¡Œ 645-648):
```python
# å›æµ‹æœ‰å»é‡
if candle_key in self.last_signal_candle and self.last_signal_candle[candle_key] == candle_time:
    continue  # åŒä¸€æ ¹Kçº¿å·²ç»å¤„ç†è¿‡
self.last_signal_candle[candle_key] = candle_time
```

**å®ç›˜ä»£ç ** (`separated_system/trade_engine.py`): æ— ç±»ä¼¼é€»è¾‘ã€‚

**å½±å“**: 
- åŒä¸€æ ¹ K çº¿å¯èƒ½è§¦å‘å¤šæ¬¡ä¸‹å•
- æ¯æ¬¡è½®è¯¢éƒ½å¯èƒ½é‡å¤è§¦å‘ä¿¡å·

**ä¿®å¤å»ºè®®**:
```python
# åœ¨ trade_engine.py ä¸­æ·»åŠ 
last_signal_candle = {}  # {(symbol, timeframe, action): candle_timestamp}

def should_execute_signal(symbol, timeframe, action, candle_time):
    key = (symbol, timeframe, action)
    if key in last_signal_candle and last_signal_candle[key] == candle_time:
        return False  # åŒä¸€æ ¹Kçº¿å·²å¤„ç†
    last_signal_candle[key] = candle_time
    return True
```

---

#### é£é™© 3: reduceOnly æœªè®¾ç½®å¯¼è‡´å¹³ä»“å˜å¼€ä»“

**é—®é¢˜**: å¹³ä»“è®¢å•æœªè®¾ç½® `reduceOnly=True`ï¼Œå¯èƒ½å¯¼è‡´å¹³ä»“å¤±è´¥æ—¶åå‘å¼€ä»“ã€‚

**è¯æ®** (`separated_system/trade_engine.py` è¡Œ 478-482):
```python
params={
    "posSide": posSide,
    "tdMode": OKX_TD_MODE
    # ç¼ºå°‘ "reduceOnly": True
}
```

**å½±å“**: 
- ç´§æ€¥å¹³ä»“æ—¶å¦‚æœæ–¹å‘åˆ¤æ–­é”™è¯¯ï¼Œå¯èƒ½å¼€å‡ºåå‘ä»“ä½
- æ­¢ç›ˆ/æ­¢æŸå¹³ä»“å¯èƒ½å˜æˆåŠ ä»“

**ä¿®å¤å»ºè®®**:
```python
# å¹³ä»“è®¢å•å¿…é¡»æ·»åŠ  reduceOnly
params={
    "posSide": posSide,
    "tdMode": OKX_TD_MODE,
    "reduceOnly": True  # ç¡®ä¿åªèƒ½å‡ä»“
}
```

---

### âš ï¸ P1 - é«˜é£é™© (å°½å¿«ä¿®å¤)

#### é£é™© 4: ä»“ä½æ¨¡å¼æœªæ˜¾å¼è®¾ç½®

**é—®é¢˜**: ä»£ç å‡è®¾è´¦æˆ·å·²æ˜¯åŒå‘æŒä»“æ¨¡å¼ï¼Œä½†æœªè°ƒç”¨ `set_position_mode` ç¡®è®¤ã€‚

**è¯æ®**: å…¨å±€æœç´¢ `set_position_mode|position_mode|positionMode` æ— åŒ¹é…ç»“æœã€‚

**OKX è§„åˆ™**: 
- è´¦æˆ·é»˜è®¤å¯èƒ½æ˜¯å‡€æŒä»“æ¨¡å¼ (net)
- åŒå‘æŒä»“éœ€è¦è°ƒç”¨ `POST /api/v5/account/set-position-mode` è®¾ç½®
- æ¨¡å¼ä¸åŒ¹é…æ—¶ä¸‹å•ä¼šæŠ¥é”™

**ä¿®å¤å»ºè®®**:
```python
def ensure_position_mode(self, mode='long_short_mode'):
    """ç¡®ä¿è´¦æˆ·å¤„äºæ­£ç¡®çš„ä»“ä½æ¨¡å¼"""
    try:
        # OKX API: set-position-mode
        result = self.exchange.set_position_mode(hedged=True)  # åŒå‘æŒä»“
        logger.info(f"Position mode set to: {mode}")
    except Exception as e:
        if 'already' in str(e).lower():
            logger.info("Position mode already set correctly")
        else:
            raise
```

---

#### é£é™© 5: æ æ†æœªåœ¨ä¸‹å•å‰è®¾ç½®

**é—®é¢˜**: ç­–ç•¥ä¿¡å·åŒ…å« `leverage: 50`ï¼Œä½†ä¸‹å•å‰æœªè°ƒç”¨ `set_leverage`ã€‚

**è¯æ®** (`strategy_v2.py` è¡Œ 609):
```python
"leverage": 50,  # ä¿¡å·ä¸­æŒ‡å®šæ æ†
```

ä½† `trade_engine.py` ä¸‹å•é€»è¾‘ä¸­æœªè°ƒç”¨ `set_leverage`ã€‚

**å½±å“**: 
- å®é™…æ æ†å¯èƒ½ä¸ç­–ç•¥é¢„æœŸä¸ç¬¦
- å¯èƒ½ä½¿ç”¨è´¦æˆ·é»˜è®¤æ æ† (é€šå¸¸è¾ƒä½)

**ä¿®å¤å»ºè®®**:
```python
# ä¸‹å•å‰è®¾ç½®æ æ†
if 'leverage' in plan_order:
    exchange.set_leverage(plan_order['leverage'], symbol)
```

---

#### é£é™© 6: ä»…æ”¯æŒå¸‚ä»·å•ï¼Œæ— é™ä»·å•/æ­¢æŸå•

**é—®é¢˜**: å½“å‰ä»…æ”¯æŒ `market` è®¢å•ç±»å‹ï¼Œæ— æ³•è®¾ç½®æ­¢æŸæ­¢ç›ˆã€‚

**è¯æ®** (`exchange_adapters/okx_adapter.py` è¡Œ 524):
```python
def create_order(self, symbol: str, side: str, amount: float, 
                 order_type: str = 'market', ...):  # é»˜è®¤å¸‚ä»·å•
```

**å½±å“**: 
- æ— æ³•åœ¨ä¸‹å•æ—¶é™„å¸¦æ­¢æŸ
- æ»‘ç‚¹é£é™©è¾ƒé«˜
- æ— æ³•ä½¿ç”¨æ¡ä»¶å•

**ä¿®å¤å»ºè®®**: æ‰©å±•æ”¯æŒ limitã€stop-lossã€take-profit è®¢å•ç±»å‹ã€‚


---

### âš ï¸ P2 - ä¸­é£é™© (è®¡åˆ’ä¿®å¤)

#### é£é™© 7: æŒä»“å­—æ®µè§£æä¸ä¸€è‡´

**é—®é¢˜**: ä¸åŒæ–‡ä»¶ä½¿ç”¨ä¸åŒçš„æŒä»“å­—æ®µåã€‚

**è¯æ®**:
- `trade_engine.py`: ä½¿ç”¨ `position.get("positionAmt")`
- `okx_client.py`: ä½¿ç”¨ `p.get('contracts')`

**å½±å“**: 
- ccxt è¿”å›çš„æŒä»“ç»“æ„å¯èƒ½å› ç‰ˆæœ¬ä¸åŒè€Œå˜åŒ–
- å­—æ®µåä¸ä¸€è‡´å¯èƒ½å¯¼è‡´è§£æé”™è¯¯

**ä¿®å¤å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨ ccxt æ ‡å‡†å­—æ®µï¼Œæ·»åŠ å­—æ®µæ˜ å°„å±‚ã€‚

---

#### é£é™© 8: ç¯å¢ƒå˜é‡ä¸ UI æ¨¡å¼ä¸åŒæ­¥

**é—®é¢˜**: `OKX_SANDBOX` ç¯å¢ƒå˜é‡ä¸ UI çš„"å®ç›˜æµ‹è¯•/å®ç›˜"æ¨¡å¼æ¦‚å¿µä¸åŒã€‚

**è¯æ®** (`app.py` è¡Œ 91-92):
```python
env_map = {
    "ğŸ›°ï¸ å®ç›˜æµ‹è¯•": {"api_source": "live", "is_sandbox": False, "allow_trading": False},
    "ğŸ’° å®ç›˜": {"api_source": "live", "is_sandbox": False, "allow_trading": True}
}
```

**è¯´æ˜**: 
- UI çš„"å®ç›˜æµ‹è¯•"æ˜¯æŒ‡ä½¿ç”¨å®ç›˜ API ä½†ä¸ä¸‹å•
- `OKX_SANDBOX` æ˜¯æŒ‡ä½¿ç”¨ OKX æ¨¡æ‹Ÿç›˜ API
- ä¸¤è€…æ¦‚å¿µä¸åŒï¼Œå¯èƒ½é€ æˆæ··æ·†

**ä¿®å¤å»ºè®®**: åœ¨ UI ä¸­æ˜ç¡®è¯´æ˜ä¸¤ç§æ¨¡å¼çš„åŒºåˆ«ï¼Œæˆ–ç»Ÿä¸€å‘½åã€‚

---

#### é£é™© 9: æ— è®¢å•çŠ¶æ€è¿½è¸ª

**é—®é¢˜**: ä¸‹å•åä»…è®°å½•æ—¥å¿—ï¼ŒæœªæŒä¹…åŒ–è®¢å•çŠ¶æ€ã€‚

**è¯æ®** (`separated_system/trade_engine.py` è¡Œ 957):
```python
logger.info(f"è®¢å•å‘é€æˆåŠŸ: order_id={order_result.get('order_id', 'unknown')}")
# æœªå†™å…¥æ•°æ®åº“
```

**å½±å“**: 
- æ— æ³•æŸ¥è¯¢å†å²è®¢å•
- æ— æ³•å¤„ç†éƒ¨åˆ†æˆäº¤
- é‡å¯åä¸¢å¤±è®¢å•çŠ¶æ€

**ä¿®å¤å»ºè®®**: åˆ›å»º `orders` è¡¨ï¼ŒæŒä¹…åŒ–è®¢å•çŠ¶æ€ã€‚

---

#### é£é™© 10: å¹¶å‘å®‰å…¨é—®é¢˜

**é—®é¢˜**: `session_state` åœ¨ Streamlit å›è°ƒä¸­å¯èƒ½å­˜åœ¨ç«æ€æ¡ä»¶ã€‚

**è¯æ®** (`ui_legacy.py` å¤šå¤„å›è°ƒ):
```python
def _on_env_mode_change():
    st.session_state.env_mode = sel  # ç›´æ¥ä¿®æ”¹
```

**å½±å“**: 
- å¤šä¸ªå›è°ƒåŒæ—¶ä¿®æ”¹ session_state å¯èƒ½å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´
- Streamlit çš„ rerun æœºåˆ¶å¯èƒ½å¯¼è‡´çŠ¶æ€ä¸¢å¤±

**ä¿®å¤å»ºè®®**: ä½¿ç”¨æ•°æ®åº“ä½œä¸º SSOT (Single Source of Truth)ï¼Œsession_state ä»…ä½œç¼“å­˜ã€‚

---

## å››ã€æ•°æ®ä¸æ‰§è¡Œé“¾è·¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®ä¸æ‰§è¡Œé“¾è·¯                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  1. è¡Œæƒ…è·å– (REST è½®è¯¢)                                            â”‚
â”‚     â”œâ”€â”€ market_data_provider.py::get_ohlcv()                       â”‚
â”‚     â”œâ”€â”€ exchange_adapters/okx_adapter.py::fetch_ohlcv()            â”‚
â”‚     â””â”€â”€ ccxt.okx.fetch_ohlcv()                                     â”‚
â”‚                                                                     â”‚
â”‚  2. ç­–ç•¥å†³ç­–                                                        â”‚
â”‚     â”œâ”€â”€ strategy_v2.py::TradingStrategy.analyze()                  â”‚
â”‚     â”œâ”€â”€ è®¡ç®—æŒ‡æ ‡: EMA, RSI, MACD, Stochastic, OBV                  â”‚
â”‚     â””â”€â”€ ç”Ÿæˆä¿¡å·: BUY/SELL + type + leverage                       â”‚
â”‚                                                                     â”‚
â”‚  3. ä¸‹å•æ‰§è¡Œ                                                        â”‚
â”‚     â”œâ”€â”€ separated_system/trade_engine.py::main_loop()              â”‚
â”‚     â”œâ”€â”€ exchange_adapters/okx_adapter.py::create_order()           â”‚
â”‚     â”œâ”€â”€ risk_control.py::validate_order()                          â”‚
â”‚     â””â”€â”€ ccxt.okx.create_order()                                    â”‚
â”‚                                                                     â”‚
â”‚  4. è®¢å•å›æŠ¥                                                        â”‚
â”‚     â”œâ”€â”€ ccxt è¿”å› order_result                                     â”‚
â”‚     â”œâ”€â”€ æ—¥å¿—è®°å½• (æ— æŒä¹…åŒ–)                                         â”‚
â”‚     â””â”€â”€ ç¼“å­˜å¤±æ•ˆ: invalidate_positions(), invalidate_balance()     â”‚
â”‚                                                                     â”‚
â”‚  5. UI å±•ç¤ºæ›´æ–°                                                     â”‚
â”‚     â”œâ”€â”€ app.py::main() â†’ render_main()                             â”‚
â”‚     â”œâ”€â”€ ui_legacy.py::render_dashboard()                           â”‚
â”‚     â””â”€â”€ streamlit_autorefresh (3ç§’è½®è¯¢)                            â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€ä¿®å¤ä¼˜å…ˆçº§æ±‡æ€»

| ä¼˜å…ˆçº§ | é£é™©ç¼–å· | é£é™©æè¿° | ä¿®å¤å·¥ä½œé‡ | çŠ¶æ€ |
|--------|----------|----------|------------|------|
| **P0** | 1 | æ—  clOrdId å¹‚ç­‰ä¿æŠ¤ | å° (1h) | âœ… å·²ä¿®å¤ |
| **P0** | 2 | å®ç›˜æ— ä¿¡å·å»é‡ | ä¸­ (2h) | âœ… å·²ä¿®å¤ |
| **P0** | 3 | reduceOnly æœªè®¾ç½® | å° (0.5h) | âœ… å·²ä¿®å¤ |
| **P1** | 4 | ä»“ä½æ¨¡å¼æœªæ˜¾å¼è®¾ç½® | å° (1h) | âœ… å·²ä¿®å¤ |
| **P1** | 5 | æ æ†æœªåœ¨ä¸‹å•å‰è®¾ç½® | å° (1h) | âœ… å·²ä¿®å¤ |
| **P1** | 6 | ä»…æ”¯æŒå¸‚ä»·å• | å¤§ (4h) | â³ å¾…ä¿®å¤ |
| **P2** | 7 | æŒä»“å­—æ®µè§£æä¸ä¸€è‡´ | ä¸­ (2h) | âœ… å·²ä¿®å¤ |
| **P2** | 8 | ç¯å¢ƒå˜é‡ä¸ UI æ¨¡å¼ä¸åŒæ­¥ | å° (1h) | âœ… å·²ä¿®å¤ |
| **P2** | 9 | æ— è®¢å•çŠ¶æ€è¿½è¸ª | å¤§ (4h) | âœ… å·²ä¿®å¤ |
| **P2** | 10 | å¹¶å‘å®‰å…¨é—®é¢˜ | ä¸­ (2h) | âœ… å·²ä¿®å¤ |

---

## å…­ã€å®¡è®¡ç»“è®º

1. **ä»“ä½ä½“ç³»**: é¡¹ç›®è®¾è®¡ä¸ºåŒå‘æŒä»“æ¨¡å¼ï¼Œé€šè¿‡ `posSide` åŒºåˆ†å¤šç©ºï¼Œä½†æœªæ˜¾å¼è°ƒç”¨ API ç¡®è®¤è´¦æˆ·æ¨¡å¼ã€‚

2. **ä¸‹å•æ–¹å¼**: ä½¿ç”¨ ccxt REST APIï¼Œä¼ é€’äº† `posSide` å’Œ `tdMode`ï¼Œä½†ç¼ºå°‘ `clOrdId` å’Œ `reduceOnly`ã€‚

3. **äº¤æ˜“ç­–ç•¥**: åŸºäºå¤šå‘¨æœŸ K çº¿æŠ€æœ¯æŒ‡æ ‡ï¼Œä¿¡å·ç±»å‹ä¸°å¯Œï¼Œä½†å®ç›˜ç¼ºå°‘ä¿¡å·å»é‡æœºåˆ¶ã€‚

4. **ä¸»è¦é£é™©**: 
   - æ— è®¢å•å¹‚ç­‰æ€§ä¿æŠ¤ (P0)
   - å®ç›˜ä¿¡å·å¯èƒ½é‡å¤è§¦å‘ (P0)
   - å¹³ä»“è®¢å•å¯èƒ½å˜å¼€ä»“ (P0)

5. **å»ºè®®**: ä¼˜å…ˆä¿®å¤ P0 çº§åˆ«é£é™©ï¼Œå†é€æ­¥å®Œå–„ P1/P2 é—®é¢˜ã€‚

---

*å®¡è®¡æŠ¥å‘Šç»“æŸ*


---

## ä¸ƒã€ä¿®å¤å®æ–½è®°å½• (2024-12-16)

### å·²å®Œæˆä¿®å¤

#### P0-1: clOrdId å¹‚ç­‰ä¿æŠ¤ âœ…
**æ–‡ä»¶**: `exchange_adapters/okx_adapter.py`
- æ–°å¢ `generate_client_order_id()` æ–¹æ³•ç”Ÿæˆå”¯ä¸€è®¢å•ID
- æ ¼å¼: `{side}_{symbolç®€å†™}_{æ—¶é—´æˆ³}_{uuidçŸ­ç }`
- ä¸‹å•æ—¶è‡ªåŠ¨æ·»åŠ  `clOrdId` å‚æ•°

#### P0-2: å®ç›˜ä¿¡å·å»é‡ âœ…
**æ–‡ä»¶**: `separated_system/trade_engine.py`, `exchange_adapters/okx_adapter.py`
- æ–°å¢å…¨å±€å˜é‡ `_last_signal_candle` è®°å½•å·²å¤„ç†çš„Kçº¿
- æ–°å¢ `should_execute_signal()` å‡½æ•°æ£€æŸ¥ä¿¡å·æ˜¯å¦é‡å¤
- åŒä¸€æ ¹Kçº¿çš„åŒä¸€ä¿¡å·åªæ‰§è¡Œä¸€æ¬¡

#### P0-3: reduceOnly å¹³ä»“ä¿æŠ¤ âœ…
**æ–‡ä»¶**: `exchange_adapters/okx_adapter.py`, `separated_system/trade_engine.py`
- `create_order()` æ–°å¢ `reduce_only` å‚æ•°
- æ–°å¢ `create_close_order()` æ–¹æ³•è‡ªåŠ¨è®¾ç½® `reduceOnly=True`
- ç´§æ€¥å¹³ä»“é€»è¾‘å·²æ·»åŠ  `reduceOnly: True`

#### P1-4: ä»“ä½æ¨¡å¼è®¾ç½® âœ…
**æ–‡ä»¶**: `exchange_adapters/okx_adapter.py`
- æ–°å¢ `ensure_position_mode()` æ–¹æ³•
- æ”¯æŒåŒå‘æŒä»“ (hedged=True) å’Œå•å‘æŒä»“ (hedged=False)
- ä¸‹å•å‰è‡ªåŠ¨è°ƒç”¨ç¡®ä¿æ¨¡å¼æ­£ç¡®

#### P1-5: æ æ†è®¾ç½® âœ…
**æ–‡ä»¶**: `exchange_adapters/okx_adapter.py`, `separated_system/trade_engine.py`
- æ–°å¢ `ensure_leverage()` æ–¹æ³•å¸¦ç¼“å­˜
- ä¸‹å•å‰è‡ªåŠ¨è®¾ç½®æ æ†
- é¿å…é‡å¤è®¾ç½®ç›¸åŒæ æ†

#### P2-7: æŒä»“å­—æ®µç»Ÿä¸€ âœ…
**æ–‡ä»¶**: `exchange_adapters/okx_adapter.py`
- æ–°å¢ `normalize_position()` æ–¹æ³•ç»Ÿä¸€å­—æ®µæ ¼å¼
- æ–°å¢ `get_active_positions()` æ–¹æ³•è¿”å›æ ‡å‡†åŒ–æŒä»“
- å…¼å®¹ ccxt ä¸åŒç‰ˆæœ¬çš„å­—æ®µå

#### P2-9: è®¢å•çŠ¶æ€æŒä¹…åŒ– âœ…
**æ–‡ä»¶**: `db_bridge.py`
- æ–°å¢ `orders` è¡¨å­˜å‚¨è®¢å•è®°å½•
- æ–°å¢ `insert_order()` æ’å…¥è®¢å•
- æ–°å¢ `update_order_status()` æ›´æ–°çŠ¶æ€
- æ–°å¢ `get_order_by_cl_ord_id()` æŸ¥è¯¢è®¢å•
- æ–°å¢ `get_recent_orders()` è·å–å†å²è®¢å•

#### P2-8: ç¯å¢ƒå˜é‡ä¸ UI æ¨¡å¼åŒæ­¥ âœ…
**æ–‡ä»¶**: `ui_legacy.py`
- åœ¨è¿è¡Œæ¨¡å¼é€‰æ‹©å™¨ä¸‹æ–¹æ·»åŠ è¯¦ç»†è¯´æ˜
- æ˜ç¡®åŒºåˆ†"å®ç›˜æµ‹è¯•"ï¼ˆä½¿ç”¨çœŸå®APIä½†ä¸ä¸‹å•ï¼‰å’Œ"å®ç›˜"ï¼ˆçœŸå®äº¤æ˜“ï¼‰
- æ˜¾ç¤º `OKX_SANDBOX` ç¯å¢ƒå˜é‡çŠ¶æ€è­¦å‘Š
- å¸®åŠ©ç”¨æˆ·ç†è§£ä¸¤ç§æ¨¡å¼çš„åŒºåˆ«

#### P2-10: å¹¶å‘å®‰å…¨ âœ…
**æ–‡ä»¶**: `ui_legacy.py`
- å®ç° SSOT (Single Source of Truth) è®¾è®¡æ¨¡å¼
- æ•°æ®åº“ä½œä¸ºæƒå¨æ•°æ®æºï¼Œsession_state ä»…ä½œ UI ç¼“å­˜
- æ‰€æœ‰çŠ¶æ€å˜æ›´éµå¾ª"å…ˆå†™ DBï¼Œå†æ›´æ–° session_state"åŸåˆ™
- æ·»åŠ ä¹è§‚é”ï¼ˆversionå­—æ®µï¼‰é˜²æ­¢å¹¶å‘å†²çª
- ä¿®å¤çš„å›è°ƒå‡½æ•°:
  - `_on_env_mode_change()` - è¿è¡Œæ¨¡å¼åˆ‡æ¢
  - `_on_strategy_change()` - ç­–ç•¥åˆ‡æ¢
  - `_save_api_config()` - API é…ç½®ä¿å­˜
  - äº¤æ˜“æ± ä¿å­˜é€»è¾‘

### å¾…ä¿®å¤é¡¹

#### P1-6: é™ä»·å•/æ­¢æŸå•æ”¯æŒ
éœ€è¦æ‰©å±• `create_order()` æ”¯æŒ limitã€stop-lossã€take-profit è®¢å•ç±»å‹ã€‚

---

## å…«ã€å¯è¿è¡Œä¿®å¤è®°å½• (2024-12-16 ç¬¬äºŒè½®)

### ã€Aã€‘äº¤æ˜“æ± ä¿å­˜ä¿®å¤ âœ…

**æ–°å¢æ–‡ä»¶**: `symbol_utils.py`
- å®ç° `normalize_symbol()` å‡½æ•°ï¼Œæ”¯æŒä»»æ„æ ¼å¼è¾“å…¥
- æ”¯æŒè¾“å…¥: btc, BTC, BTCUSDT, BTC-USDT, BTC/USDT, BTC/USDT:USDT, BTC-USDT-SWAP
- ç»Ÿä¸€è¾“å‡º: CCXT swap æ ¼å¼ `BTC/USDT:USDT`
- å®ç° `parse_symbol_input()` å‡½æ•°ï¼Œæ”¯æŒå¤šè¡Œ/é€—å·/ç©ºæ ¼åˆ†éš”
- åŒ…å«å®Œæ•´å•å…ƒæµ‹è¯•ï¼ˆ25ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡ï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `ui_legacy.py`
- ä½¿ç”¨ `symbol_utils.parse_symbol_input()` æ›¿ä»£åŸæœ‰çš„ `auto_align_symbol_format()`
- é¢„è§ˆæ–‡æœ¬ä¸å®é™…ä¿å­˜å†…å®¹å®Œå…¨ä¸€è‡´
- æ·»åŠ è¾“å…¥æ ¼å¼æç¤º

### ã€Bã€‘æ‰«æå¼•æ“ä¿®å¤ âœ…

**ä¿®æ”¹æ–‡ä»¶**: `separated_system/trade_engine.py`
- ä¿®å¤ `UnboundLocalError`: åœ¨å¾ªç¯å¼€å§‹æ—¶åˆå§‹åŒ– `plan_order = None`
- åŒæ—¶åˆå§‹åŒ– `can_execute_real_order`, `can_execute_paper_order`, `blocked_reasons`
- å®‰å…¨å¤„ç† `plan_order` çš„ JSON åºåˆ—åŒ–ï¼Œä½¿ç”¨ try-except åŒ…è£¹

### ã€Cã€‘UI ç²¾ç®€ âœ…

**ä¿®æ”¹æ–‡ä»¶**: `ui_legacy.py`
- ç³»ç»Ÿæ§åˆ¶åŒºåŸŸç²¾ç®€ä¸º 3 ä¸ªæŒ‰é’®:
  1. âœ… å¯ç”¨äº¤æ˜“ - è®¾ç½® enable_trading=1
  2. â¹ï¸ å…³é—­äº¤æ˜“ - è®¾ç½® enable_trading=0
  3. ğŸ”¥ ä¸€é”®å¹³ä»“ - å‘é€ emergency_flatten ä¿¡å·
- åˆ é™¤å†—ä½™æŒ‰é’®: é‡è½½é…ç½®ã€æ¢å¤äº¤æ˜“ã€åœæ­¢å¼•æ“
- æ·»åŠ äº¤æ˜“çŠ¶æ€æ˜¾ç¤ºï¼ˆğŸŸ¢/ğŸ”´ï¼‰
- æŒ‰é’®æ ¹æ®å½“å‰çŠ¶æ€è‡ªåŠ¨ç¦ç”¨

---

## ä¹ã€ç¬¬ä¸‰è½®ä¿®å¤è®°å½• (2024-12-16)

### ã€Dã€‘è¿è¡Œæ¨¡å¼åˆ‡æ¢è‡ªåŠ¨å…³é—­äº¤æ˜“ âœ…

**é—®é¢˜**: åˆ‡æ¢è¿è¡Œæ¨¡å¼æ—¶ï¼Œäº¤æ˜“çŠ¶æ€åº”è¯¥è‡ªåŠ¨å…³é—­ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨é‡æ–°å¯ç”¨

**ä¿®æ”¹æ–‡ä»¶**: `ui_legacy.py`
- `_on_env_mode_change()` å›è°ƒå‡½æ•°ä¸­æ·»åŠ è‡ªåŠ¨å…³é—­äº¤æ˜“é€»è¾‘
- åˆ‡æ¢æ¨¡å¼æ—¶è®¾ç½® `enable_trading=0` å’Œ `pause_trading=1`
- æ›´æ–° `st.session_state.trading_active = False`

### ã€Eã€‘åç«¯å¯åŠ¨ä¸è‡ªåŠ¨å¼€å¯äº¤æ˜“ âœ…

**é—®é¢˜**: åç«¯å¯åŠ¨åä¸åº”è¯¥è‡ªåŠ¨å¼€å¯äº¤æ˜“ï¼Œéœ€è¦å‰ç«¯æ‰‹åŠ¨å†³ç­–

**ä¿®æ”¹æ–‡ä»¶**: `separated_system/trade_engine.py`
- å¯åŠ¨æ—¶æ‰“å°æç¤ºï¼š`âš ï¸ äº¤æ˜“åŠŸèƒ½é»˜è®¤å…³é—­ï¼Œè¯·åœ¨å‰ç«¯æ‰‹åŠ¨å¯ç”¨äº¤æ˜“`
- äº¤æ˜“çŠ¶æ€ç”±æ•°æ®åº“ `enable_trading` å­—æ®µæ§åˆ¶
- åªæœ‰å‰ç«¯ç‚¹å‡»"å¯ç”¨äº¤æ˜“"æŒ‰é’®åæ‰å¼€å§‹æ‰«æ

### ã€Fã€‘èµ„äº§çœ‹æ¿æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒä½™é¢ âœ…

**é—®é¢˜**: å®ç›˜æµ‹è¯•æ¨¡å¼åº”æ˜¾ç¤ºæ¨¡æ‹Ÿä½™é¢ï¼Œå®ç›˜æ¨¡å¼åº”æ˜¾ç¤ºçœŸå®ä½™é¢

**ä¿®æ”¹æ–‡ä»¶**: `ui_legacy.py`
- `render_sidebar()` å‡½æ•°ä¸­æ ¹æ® `env_mode` åˆ¤æ–­æ˜¾ç¤ºå†…å®¹
- å®ç›˜æµ‹è¯•æ¨¡å¼ (`ğŸ›°ï¸ å®ç›˜æµ‹è¯•`): æ˜¾ç¤ºæ¨¡æ‹Ÿè´¦æˆ·ä½™é¢ + æç¤º"ğŸ“Œ æ¨¡æ‹Ÿè´¦æˆ·ä½™é¢ï¼ˆéçœŸå®èµ„é‡‘ï¼‰"
- å®ç›˜æ¨¡å¼ (`ğŸ’° å®ç›˜`): æ˜¾ç¤º OKX çœŸå®ä½™é¢ + æç¤º"ğŸ’° OKX çœŸå®è´¦æˆ·ä½™é¢"

### ã€Gã€‘åç«¯æ—¥å¿—æ ¼å¼ä¼˜åŒ– âœ…

**é—®é¢˜**: åç«¯æ‰«ææ—¥å¿—å¤ªä¹±ï¼Œéœ€è¦å‚ç…§å¤‡ä»½æ–‡ä»¶æ ¼å¼

**ä¿®æ”¹æ–‡ä»¶**: `separated_system/trade_engine.py`
- æ·»åŠ é¢„é£æ§ç¼“å­˜å˜é‡: `cached_can_open_new`, `cached_remaining_base`, `cached_equity`
- æ¯åˆ†é’Ÿ15ç§’å’Œ45ç§’æ‰§è¡Œé¢„é£æ§æ£€æŸ¥
- æ‰“å°æ ¼å¼åŒ–æ—¥å¿—:
  - `ğŸ” å¼€å§‹é¢„é£æ§æ£€æŸ¥...`
  - `âœ… é¢„é£æ§ï¼šå·²ç”¨ $X / é™é¢ $Yï¼Œå‰©ä½™ $Z`
  - `ğŸ“Š è´¦æˆ·æƒç›Š: $X`
  - `ğŸ›¡ï¸ ä½¿ç”¨ç¼“å­˜çš„é¢„é£æ§ç»“æœ: å¯å¼€æ–°ä¸»ä»“/ä»…å…è®¸å¯¹å†²ä»“`
- æ‰«æè§¦å‘æ—¶æ˜¾ç¤º:
  - `ğŸš€ [HH:MM:SS] è§¦å‘æ‰«æ | å‘¨æœŸ: [timeframes] | å¸ç§: N`
  - `ğŸ’° è´¦æˆ·æƒç›Š: $X | å‰©ä½™å¯ç”¨æœ¬é‡‘: $Y`

---

## åã€ç¬¬å››è½®ä¿®å¤è®°å½• (2024-12-16)

### ã€Hã€‘å…¥åœºåŠ¨ç”»ä¿®å¤ âœ…

**é—®é¢˜**: å…¥åœºåŠ¨ç”»æ˜¾ç¤º"é‡åŒ–ç³»ç»Ÿ"ï¼Œåº”è¯¥æ˜¾ç¤º"ä½•ä»¥ä¸ºåŠ¿"

**ä¿®æ”¹æ–‡ä»¶**: `ui_legacy.py`, `app.py`
- å…¥åœºåŠ¨ç”»æ–‡å­—æ”¹ä¸º"ä½•ä»¥ä¸ºåŠ¿"
- ç™»å½•é¡µé¢æ ‡é¢˜æ”¹ä¸º"ğŸ” ä½•ä»¥ä¸ºåŠ¿ã®å®ç›˜ç³»ç»Ÿ"
- é¡µé¢æ ‡é¢˜è®¾ç½®ä¸º"ä½•ä»¥ä¸ºåŠ¿ã®å®ç›˜ç³»ç»Ÿ"

### ã€Iã€‘ç³»ç»Ÿæ§åˆ¶æŒ‰é’®ä¿®å¤ âœ…

**é—®é¢˜**: å¯ç”¨äº¤æ˜“æŒ‰é’®æ— æ³•ä½¿ç”¨ï¼Œå‰ç«¯æ˜¾ç¤ºä¸åç«¯çŠ¶æ€ä¸åŒæ­¥

**ä¿®æ”¹æ–‡ä»¶**: `ui_legacy.py`
- ä»æ•°æ®åº“è¯»å–çœŸå®çš„ `enable_trading` çŠ¶æ€
- æŒ‰é’®çŠ¶æ€åŸºäºæ•°æ®åº“å€¼è€Œé `view_model`
- æ·»åŠ ç‚«é…·çš„æ¸å˜æŒ‰é’®æ ·å¼ï¼ˆç»¿è‰²å¯ç”¨ã€ç°è‰²å…³é—­ã€æ©™è‰²å¹³ä»“ï¼‰
- ç‚¹å‡»æŒ‰é’®ååŒæ—¶æ›´æ–°æ•°æ®åº“å’Œ `session_state`

### ã€Jã€‘æ¨¡æ‹Ÿè´¦æˆ·ä½™é¢è¯»å–ä¿®å¤ âœ…

**é—®é¢˜**: å®ç›˜æµ‹è¯•æ¨¡å¼ä¸‹æ¨¡æ‹Ÿé‡‘é¢åº”è¯¥è¯»å–æ•°æ®åº“ä¸­çš„å®æ—¶å‡€å€¼

**ä¿®æ”¹æ–‡ä»¶**: `ui_legacy.py`, `app.py`
- ä» `actions.get_paper_balance()` è¯»å–æ¨¡æ‹Ÿè´¦æˆ·ä½™é¢
- `app.py` ä¸­å°† `paper_balance` æ·»åŠ åˆ° `view_model`
- å§‹ç»ˆè·å–æ¨¡æ‹Ÿè´¦æˆ·æ•°æ®ï¼Œä¸ä»…é™äº paper æ¨¡å¼

### ã€Kã€‘åç«¯æ—¥å¿—æ ¼å¼ä¼˜åŒ– âœ…

**é—®é¢˜**: åç«¯æ‰«ææ—¥å¿—æ ¼å¼æ··ä¹±ï¼Œéœ€è¦å‚ç…§å¤‡ä»½æ–‡ä»¶æ ¼å¼

**ä¿®æ”¹æ–‡ä»¶**: `separated_system/trade_engine.py`
- æ·»åŠ ä»·æ ¼è·å–æ—¥å¿—: `ğŸ“¡ å¼€å§‹è·å–è¡Œæƒ…æ•°æ®...`
- æ¯ä¸ªå¸ç§ä»·æ ¼è·å–æˆåŠŸ: `âœ… {symbol} ä»·æ ¼: ${price}`
- ä»·æ ¼è·å–å®Œæˆç»Ÿè®¡: `âœ… ä»·æ ¼è·å–å®Œæˆ: N/M ä¸ªå¸ç§ | è€—æ—¶: Xs`
- æ‰«æå‘¨æœŸæ—¥å¿—: `ğŸ“Š æ‰«æå‘¨æœŸ: {timeframe}`
- æ‰«æå®Œæˆæ—¥å¿—: `âœ… æœ¬è½®æ‰«æå®Œæˆ | è€—æ—¶: Xs`

---

## åä¸€ã€ç¬¬äº”è½®ä¿®å¤è®°å½• (2024-12-16)

### ã€Lã€‘é¢„é£æ§æ£€æŸ¥åªåœ¨äº¤æ˜“å¯ç”¨æ—¶æ‰§è¡Œ âœ…

**é—®é¢˜**: åç«¯æ¯15/45ç§’æ‰§è¡Œé¢„é£æ§æ£€æŸ¥ï¼Œå³ä½¿äº¤æ˜“å·²å…³é—­ä¹Ÿä¼šæ‰“å°æ—¥å¿—ï¼Œå¯¼è‡´æ—¥å¿—æ··ä¹±

**ä¿®æ”¹æ–‡ä»¶**: `separated_system/trade_engine.py`
- é¢„é£æ§æ£€æŸ¥å‰å…ˆæ£€æŸ¥ `enable_trading` å’Œ `pause_trading` çŠ¶æ€
- åªæœ‰äº¤æ˜“å¯ç”¨ä¸”æœªæš‚åœæ—¶æ‰æ‰§è¡Œé¢„é£æ§æ£€æŸ¥
- äº¤æ˜“å…³é—­æ—¶é™é»˜è·³è¿‡ï¼Œä¸æ‰“å°ä»»ä½•æ—¥å¿—
- å‡å°‘ä¸å¿…è¦çš„ API è°ƒç”¨å’Œæ—¥å¿—è¾“å‡º

### ã€Mã€‘é¢„é£æ§é€»è¾‘ä¿®å¤ âœ…

**é—®é¢˜**: æ²¡æœ‰æŒä»“æ—¶å´æ˜¾ç¤º"ä»…å…è®¸å¯¹å†²ä»“"

**ä¿®æ”¹æ–‡ä»¶**: `separated_system/trade_engine.py`
- ä¿®å¤é¢„é£æ§é€»è¾‘ï¼šå½“è·å–ä½™é¢å¤±è´¥æ—¶é»˜è®¤å…è®¸å¼€ä»“
- æ·»åŠ  `max_lev = 50` æ æ†å€æ•°å˜é‡
- å…¼å®¹ä¸åŒçš„æŒä»“å­—æ®µå (`contracts`, `positionAmt`)
- å½“æ²¡æœ‰æŒä»“æ—¶ `total_base_used = 0`ï¼Œåº”è¯¥å…è®¸å¼€æ–°ä¸»ä»“

### ã€Nã€‘äº¤æ˜“æ± åŠ è½½ä¿®å¤ âœ…

**é—®é¢˜**: åç«¯æ—¥å¿—æ˜¾ç¤º `symbols=[]`ï¼Œäº¤æ˜“æ± ä¸ºç©º

**ä¿®æ”¹æ–‡ä»¶**: `separated_system/trade_engine.py`
- æ¯æ¬¡æ‰«æå‰éƒ½ä»æ•°æ®åº“é‡æ–°åŠ è½½äº¤æ˜“æ± 
- ç¡®ä¿å‰ç«¯ä¿®æ”¹çš„äº¤æ˜“æ± ç«‹å³ç”Ÿæ•ˆ
- ç§»é™¤å¯¹ `updated_at` çš„ä¾èµ–ï¼Œç›´æ¥è¯»å–æœ€æ–°é…ç½®

### ã€Oã€‘æ—¥å¿—ç®€åŒ– âœ…

**é—®é¢˜**: åç«¯æ—¥å¿—å¤ªç¹æ‚ï¼Œé…ç½®é‡è½½ç­‰ä¸éœ€è¦æ‰“å°

**ä¿®æ”¹æ–‡ä»¶**: `separated_system/trade_engine.py`
- é…ç½®æ›´æ–°æ£€æŸ¥æ”¹ä¸ºé™é»˜æ‰§è¡Œï¼ˆä¸æ‰“å°æ—¥å¿—ï¼‰
- reload_config ä¿¡å·å¤„ç†æ”¹ä¸ºé™é»˜æ‰§è¡Œ
- åªä¿ç•™å¿…è¦çš„æ‰«ææ—¥å¿—ï¼š
  - é¢„é£æ§æ£€æŸ¥ç»“æœ
  - ä»·æ ¼è·å–
  - æ‰«æå‘¨æœŸ
  - æ‰«æå®Œæˆ

---

## åäºŒã€ç¬¬å…­è½®ä¿®å¤è®°å½• (2024-12-16)

### ã€Pã€‘é¢„é£æ§é€»è¾‘å®Œå–„ âœ…

**é—®é¢˜**: æ²¡æœ‰æŒä»“æ—¶å´æ˜¾ç¤º"ä»…å…è®¸å¯¹å†²ä»“"

**ä¿®æ”¹æ–‡ä»¶**: `separated_system/trade_engine.py`
- å½“è·å–ä½™é¢å¤±è´¥æ—¶ï¼Œé»˜è®¤å…è®¸å¼€ä»“ï¼ˆ`cached_can_open_new = True`ï¼‰
- æ·»åŠ  `max_lev = 50` æ æ†å€æ•°å˜é‡ç”¨äºæœ¬é‡‘è®¡ç®—
- å…¼å®¹ä¸åŒçš„æŒä»“å­—æ®µå (`contracts`, `positionAmt`, `entryPrice`, `markPrice`)
- å½“æ²¡æœ‰æŒä»“æ—¶ `total_base_used = 0`ï¼Œæ­£ç¡®æ˜¾ç¤º"å¯å¼€æ–°ä¸»ä»“"

### ã€Qã€‘äº¤æ˜“æ± å®æ—¶åŠ è½½ âœ…

**é—®é¢˜**: åç«¯æ—¥å¿—æ˜¾ç¤º `symbols=[]`ï¼Œäº¤æ˜“æ± ä¸ºç©º

**ä¿®æ”¹æ–‡ä»¶**: `separated_system/trade_engine.py`
- æ¯æ¬¡æ‰«æå‰éƒ½ä»æ•°æ®åº“é‡æ–°åŠ è½½äº¤æ˜“æ±  (`bot_config.get('symbols')`)
- ç¡®ä¿å‰ç«¯ä¿®æ”¹çš„äº¤æ˜“æ± ç«‹å³ç”Ÿæ•ˆ
- ä¸å†ä¾èµ– `updated_at` æ—¶é—´æˆ³åˆ¤æ–­

### ã€Rã€‘æ—¥å¿—é™é»˜å¤„ç† âœ…

**é—®é¢˜**: é…ç½®é‡è½½æ—¥å¿—å¤ªå¤š

**ä¿®æ”¹æ–‡ä»¶**: `separated_system/trade_engine.py`
- é…ç½®æ›´æ–°æ£€æŸ¥æ”¹ä¸ºé™é»˜æ‰§è¡Œï¼ˆç§»é™¤ print è¯­å¥ï¼‰
- reload_config ä¿¡å·å¤„ç†æ”¹ä¸ºé™é»˜æ‰§è¡Œ
- ä¿æŒå¿…è¦çš„æ‰«ææ—¥å¿—è¾“å‡º

---

## åä¸‰ã€ç¬¬ä¸ƒè½®ä¿®å¤è®°å½• (2024-12-16)

### ã€Sã€‘TypeError ä¿®å¤ âœ…

**é—®é¢˜**: `TypeError: 'NoneType' object is not subscriptable` - å½“ `plan_order` ä¸º `None` æ—¶è®¿é—®å…¶å±æ€§

**ä¿®æ”¹æ–‡ä»¶**: `separated_system/trade_engine.py`
- ä¿®æ”¹æ¡ä»¶åˆ¤æ–­ï¼š`else:` â†’ `elif plan_order is not None:`
- åªæœ‰å½“ `plan_order` å­˜åœ¨æ—¶æ‰è®°å½•æ‹¦æˆªæ—¥å¿—
- ä½¿ç”¨ `plan_order.get("symbol", "-")` å®‰å…¨è®¿é—®å±æ€§

### ã€Tã€‘é¢„é£æ§ provider ä¸ºç©ºå¤„ç† âœ…

**é—®é¢˜**: å½“ API æœªé…ç½®æ—¶ï¼Œ`provider` ä¸º `None`ï¼Œå¯¼è‡´é¢„é£æ§æ˜¾ç¤º"ä»…å…è®¸å¯¹å†²ä»“"

**ä¿®æ”¹æ–‡ä»¶**: `separated_system/trade_engine.py`
- åœ¨é¢„é£æ§æ£€æŸ¥å¼€å§‹æ—¶å…ˆæ£€æŸ¥ `provider is None`
- å¦‚æœ `provider` ä¸ºç©ºï¼Œæ‰“å°æç¤ºå¹¶é»˜è®¤å…è®¸å¼€ä»“
- é¿å…å›  API æœªé…ç½®å¯¼è‡´çš„è¯¯åˆ¤

### ã€Uã€‘.env ç¯å¢ƒå˜é‡åŠ è½½ âœ…

**é—®é¢˜**: åç«¯å¯åŠ¨æ—¶æœªåŠ è½½ `.env` æ–‡ä»¶ï¼Œå¯¼è‡´ `MYTRADINGBOT_MASTER_PASS` æœªè®¾ç½®ï¼ŒAPI å¯†é’¥è§£å¯†å¤±è´¥

**ä¿®æ”¹æ–‡ä»¶**: `separated_system/trade_engine.py`
- åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ  `load_dotenv()` è°ƒç”¨
- ä»é¡¹ç›®æ ¹ç›®å½•åŠ è½½ `.env` æ–‡ä»¶
- ç¡®ä¿åŠ å¯†å¯†é’¥ç­‰é…ç½®åœ¨å…¶ä»–æ¨¡å—å¯¼å…¥ä¹‹å‰æ­£ç¡®åŠ è½½

### ã€Vã€‘è¯Šæ–­è„šæœ¬ âœ…

**æ–°å¢æ–‡ä»¶**: `diagnose_db.py`
- è¯Šæ–­æ•°æ®åº“é…ç½®é—®é¢˜
- æ£€æŸ¥ `bot_config` è¡¨å†…å®¹
- æ£€æŸ¥ API å¯†é’¥è§£å¯†çŠ¶æ€
- æ£€æŸ¥æ¨¡æ‹Ÿè´¦æˆ·ä½™é¢

---

*ä¿®å¤è®°å½•æ›´æ–°äº 2024-12-16*
